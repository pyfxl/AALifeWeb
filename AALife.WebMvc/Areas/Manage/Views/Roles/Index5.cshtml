@{
    ViewBag.Title = "角色列表 2";
}

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div id="main">
                <div id="grid"></div>
            </div>
        </div><!-- /.col -->
    </div><!-- /.row -->
</section>

@section scripts {
<script src="~/Areas/Manage/Scripts/roles.js"></script>
<script>
    $(document).ready(function () {

        //列表数据源
        var dataSource = new kendo.data.DataSource($.extend(true, {}, $.const.kendolite.dataSource, {
            transport: {
                read: {
                    url: $.const.webapi.roles,
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    cache: false
                },
                parameterMap: function (options, operation) {
                    if (operation !== "read" && options.models) {
                        return kendo.stringify(options.models[0]);
                    }
                    return options;
                }
            },
            schema: {
                model: {
                    id: "Id",
                    fields: {
                        Id: { type: "string", editable: false, nullable: false },
                        Name: { type: "string" },
                        SystemName: { type: "string" }
                    }
                }
            },
            error: function (e) {
                kendoui_grid_error(e);
            }
        }));

        //角色列表
        var grid = $("#grid").kendoGrid($.extend(true, {}, $.const.kendolite, {
            dataSource: dataSource,
            detailTemplate: '<div class="detailgrid"></div>',
            detailInit: detailInit,
            columns: [
                {
                    field: "Id",
                    title: "编号",
                    width: 100
                },
                {
                    field: "Name",
                    title: "角色名称",
                    width: 100
                },
                {
                    field: "SystemName",
                    title: "系统名称",
                    width: 100
                }
            ]
        })).data("kendoGrid");

        //加载子列表
        function detailInit(event) {
            var keyId = event.data.Id;
            var detailRow = event.detailRow;

            //用户来自数据源
            var dataUserFrom = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: String.format($.const.webapi.paramsbyname, "userfrom"),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8"
                    }
                }
            });

            //选择用户列表
            var userGrid = detailRow.find(".detailgrid").kendoGrid($.extend(true, {}, $.const.kendogrid, {
                dataSource: {
                    transport: {
                        read: {
                            url: String.format($.const.webapi.userroleselects, keyId),
                            cache: false,
                            dataType: "json"
                        },
                        parameterMap: function (options, type) {
                            return options;
                        }
                    },
                    schema: {
                        model: {
                            id: "Id",
                            fields: {
                                Id: { type: "string" },
                                UserName: { type: "string" },
                                UserNickName: { type: "string" },
                                UserImage: { type: "string" },
                                UserImageFull: { type: "string" },
                                UserFrom: { type: "string" },
                                UserFromName: { type: "string" },
                                CreateDate: { type: "date" },
                                Remark: { type: "string" },
                                IsCurrentRole: { type: "boolean" }
                            }
                        }
                    },
                    error: function (e) {
                        kendoui_grid_error(e);
                    },
                    pageSize: 10
                },
                columns: [
                    {
                        selectable: true,
                        width: 100
                    },
                    {
                        field: "Id",
                        title: "编号",
                        width: 100,
                        hidden: true
                    },
                    {
                        field: "UserName",
                        title: "用户名",
                        width: 100
                    },
                    {
                        field: "UserNickName",
                        title: "昵称",
                        width: 100
                    },
                    {
                        template: "<div class='user-block'><img src='#=UserImageFull#' class='img-circle'/></div>",
                        field: "UserImage",
                        title: "头像",
                        width: 100,
                        attributes: { class: "user-img-td" }
                    },
                    {
                        template: "#=UserFromName#",
                        field: "UserFrom",
                        title: "来自",
                        width: 100,
                        filterable: {
                            multi: true,
                            dataSource: dataUserFrom,
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.Value #'/> #= data.Name || data.all #</label></li>"
                            }
                        }
                    },
                    {
                        field: "CreateDate",
                        title: "注册日期",
                        width: 100,
                        format: "{0:yyyy/MM/dd}"
                    },
                    {
                        field: "Remark",
                        title: "备注",
                        width: 100
                    }
                ],
                dataBound: function (e) {
                    var grid = this;
                    var rows = grid.items(), n = 0;
                    $.each(rows, function (i) {
                        var row = this;
                        var dataItem = grid.dataItem(row);
                        if (dataItem.IsCurrentRole) {
                            n++;
                            //grid.select(row);
                            $(row).addClass("k-state-selected");
                            $(row).find(".k-checkbox").prop("checked", true);
                        }
                        if (n == rows.length) {
                            var header = $(row).parents(".detailgrid").find(".k-grid-header .k-header").eq(0);
                            header.find(".k-checkbox").prop("checked", true);
                        }
                    });
                },
                change: function (e) {
                    var current = e.sender.current();
                    if (current) {
                        if (current[0].className == "k-header") {
                            var selectedRows = this.select();
                            var selectedDataItems = [];
                            for (var i = 0; i < selectedRows.length; i++) {
                                var dataItem = this.dataItem(selectedRows[i]);
                                selectedDataItems.push(dataItem);
                            }
                            // selectedDataItems contains all selected data items
                            insert_userrole(keyId, selectedDataItems);                                
                        } else {
                            var selectedRow = current.parent();
                            var dataItem = this.dataItem(selectedRow);
                            if (dataItem)
                                insert_update_userrole(keyId, dataItem);
                        }
                    }
                }
            })).data("kendoGrid");

        }

    });
</script>
}

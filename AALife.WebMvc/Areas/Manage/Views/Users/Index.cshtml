@using System.Configuration;
@using AALife.Core.Infrastructure;
@using AALife.Data;

@{
    ViewBag.Title = "用户列表";
}

<section class="content-header">
    <div class="row">
        <div class="col-xs-12">
            <form class="form-inline">
                <div class="form-group">
                    <div id="buttondown"></div>
                </div>
                <div class="form-group">
                    <label>关键字</label>
                    <input class="k-textbox" id="keysearch" value="" placeholder="用户名/昵称/邮箱" />
                </div>
            </form>
        </div><!-- /.col -->
    </div><!-- /.row -->
</section>

<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div id="main">
                <div id="grid">
                    @*@Html.CreateButton("Manage", "Users", "Index", 1)*@
                </div>
            </div>
        </div><!-- /.col -->
    </div><!-- /.row -->
</section>

@section scripts {
    <script>

        $(document).ready(function () {

            //刷新高度
            resizeMain();

            //列表数据源
            var dataSource = new kendo.data.DataSource($.extend(true, {}, $.const.kendogrid.dataSource, {
                transport: {
                    read: {
                        url: $.const.webapi.users,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        data: function (d) { return getQuery() },
                        cache: false
                    },
                    create: {
                        url: $.const.webapi.users,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        type: "POST",
                        complete: function (xhr, textStatus) {
                            kendoui_grid_complete(textStatus);
                        }
                    },
                    update: {
                        url: $.const.webapi.users,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        type: "PUT",
                        complete: function (xhr, textStatus) {
                            kendoui_grid_complete(textStatus);
                        }
                    },
                    destroy: {
                        url: $.const.webapi.users,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        type: "DELETE",
                        complete: function (xhr, textStatus) {
                            kendoui_grid_complete(textStatus);
                        }
                    },
                    parameterMap: function (options, operation) {
                        kendoui_parameter_format(options);
                        if (operation !== "read" && options.models) {
                            return kendo.stringify(options.models[0]);
                        }
                        return options;
                    }
                },
                schema: {
                    model: {
                        id: "Id",
                        fields: {
                            Id: { type: "number", editable: false, nullable: false },
                            UserName: {
                                type: "string",
                                validation: {
                                    required: true,
                                    validationMessage: "必填项！",
                                    usernamevalidation: function (input) {
                                        if (input.is("[name='UserName']") && input.val() != "") {
                                            input.attr("data-usernamevalidation-msg", "长度3-20位");
                                            return input.val().length >= 3 && input.val().length <= 20;
                                        }
                                        return true;
                                    }
                                }
                            },
                            UserPassword: { type: "string", validation: { required: true, validationMessage: "必填项！" } },
                            UserNickName: { type: "string" },
                            UserImage: { type: "string" },
                            UserImageFull: { type: "string" },
                            UserTheme: { type: "string" },
                            UserThemeName: { type: "string" },
                            UserLevel: { type: "number" },
                            UserLevelName: { type: "string" },
                            UserFrom: { type: "string" },
                            UserFromName: { type: "string" },
                            ModifyDate: { type: "date", editable: false },
                            CreateDate: { type: "date", editable: false },
                            Synchronize: { type: "number", defaultValue: 1, validation: { min: 0, max: 1 } },
                            Remark: { type: "string" },
                            IsAdmin: { type: "boolean" }
                        }
                    }
                },
                error: function (e) {
                    kendoui_grid_error(e); //TODO: 出错后，取消不起作用，注释下面的就正常了
                    grid.cancelChanges();
                    //grid.one("dataBinding", function (e) {
                    //    e.preventDefault();
                    //});
                },
                pageSize: $.const.default.PageNumber
            }));

            //列表
            var grid = $("#grid").kendoGrid($.extend(true, {}, $.const.kendogrid, {
                dataSource: dataSource,
                autoBind: false,
                selectable: false,
                editable: "popup",
                edit: function() {
                    var items = $(".k-edit-form-container").children(".k-edit-label, .k-edit-field");
                    for (var i = 0, len = items.length; i < len; i += 2) {
                        items.slice(i, i + 2).wrapAll("<div class=\"col-xs-6\"></div>");
                    }
                    var cols = $(".k-edit-form-container").children(".col-xs-6");
                    for (var i = 0, len = cols.length; i < len; i += 2) {
                        cols.slice(i, i + 2).wrapAll("<div class=\"row\"></div>");
                    }
                    $(".k-edit-form-container").css("width", "800px");
                    $(".k-edit-form-container").addClass("container");
                    //$('.k-window').css({ top: (($(window).innerHeight() - $('.k-window').innerHeight()) / 2), left: (($(window).innerWidth() - $('.k-edit-form-container').innerWidth()) / 2) });
                },
                toolbar: ["create", "excel"],
                pageable: {
                    pageSizes: $.const.default.PageNumbers,
                },
                columns: [
                    {
                        command: [
                            { name: "edit", text: { edit: " ", cancel: " ", update: " " } },
                            { name: "destroy", text: " " }
                        ],
                        title: "&nbsp;",
                        width: 100
                    },
                    {
                        template: "<a href='@Url.Action("Details", "Users")/#:Id#'>#:Id#</a>",
                        field: "Id",
                        title: "编号",
                        width: 80,
                        attributes: { class: "text-light-blue" }
                    },
                    {
                        field: "UserName",
                        title: "用户名",
                        width: 100
                    },
                    {
                        field: "UserPassword",
                        title: "密码",
                        width: 100
                    },
                    {
                        field: "UserNickName",
                        title: "昵称",
                        width: 100
                    },
                    {
                        template: "<div class='user-block'><img src='#= UserImageFull ? UserImageFull : \"/images/users/user.gif\" #' class='img-circle'/></div>",
                        field: "UserImage",
                        title: "头像",
                        width: 100,
                        attributes: { class: "user-img-td" },
                        editor: function (container, options) {
                            if (options.model.Id == 0) {
                                $("<div class='user-block'><img src='/Images/Users/user.gif' class='img-circle'/></div>").appendTo(container);
                                return;
                            }
                            var input = $("<input type='file' />");
                            input.attr("name", options.field);
                            input.appendTo(container);
                            input.kendoUpload({
                                multiple: false,
                                showFileList: false,
                                async: {
                                    saveUrl: '/api/v1/userimageapi?userId=' + options.model.Id,
                                    autoUpload: true
                                },
                                localization: {
                                    select: "选择"
                                },
                                validation: {
                                    allowedExtensions: [".jpg", ".png", ".gif", ".bmp"]
                                },
                                success: function (e) {
                                    notification.show("头像更新成功。", "success");
                                    $("#grid").data("kendoGrid").dataSource.read();
                                },
                                error: function (e) {
                                    notification.show("头像更新失败！", "error");
                                }
                            });
                        }
                    },
                    {
                        field: "UserTheme",
                        values: @Html.Raw(Json.Encode(ViewBag.DataTheme)),
                        title: "样式",
                        width: 100,
                        filterable: {
                            multi: true,
                            dataSource: @Html.Raw(Json.Encode(ViewBag.DataTheme)),
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.value #'/> #= data.text || data.all #</label></li>";
                            }
                        }
                    },
                    {
                        field: "UserLevel",
                        values: @Html.Raw(Json.Encode(ViewBag.DataUserLevel)),
                        title: "等级",
                        width: 100,
                        filterable: {
                            multi: true,
                            dataSource: @Html.Raw(Json.Encode(ViewBag.DataUserLevel)),
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.value #'/> #= data.text || data.all #</label></li>";
                            }
                        }
                    },
                    {
                        field: "UserFrom",
                        values: @Html.Raw(Json.Encode(ViewBag.DataUserFrom)),
                        title: "来自",
                        width: 120,
                        filterable: {
                            multi: true,
                            dataSource: @Html.Raw(Json.Encode(ViewBag.DataUserFrom)),
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.value #'/> #= data.text || data.all #</label></li>";
                            }
                        }
                    },
                    {
                        field: "CreateDate",
                        title: "注册日期",
                        width: 160,
                        format: "{0:yyyy/MM/dd HH:mm:ss}"
                    },
                    {
                        field: "ModifyDate",
                        title: "修改日期",
                        width: 160,
                        format: "{0:yyyy/MM/dd HH:mm:ss}"
                    },
                    {
                        template: "#= Synchronize == 1 ? '<i class=\"fa fa-check\"></i>' : '<i class=\"fa fa-close\"></i>' #",
                        attributes: { class: "text-center" },
                        field: "Synchronize",
                        title: "同步否",
                        width: 90,
                        format: "{0:0}",
                        filterable: {
                            multi: true,
                            dataSource: $.const.default.TrueFalse,
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.Value #'/> #= data.Name || data.all #</label></li>";
                            }
                        }
                    },
                    {
                        template: "#= IsAdmin ? '<i class=\"fa fa-check\"></i>' : '<i class=\"fa fa-close\"></i>' #",
                        attributes: { class: "text-center" },
                        field: "IsAdmin",
                        title: "管理员否",
                        width: 90,
                        format: "{0:0}",
                        filterable: {
                            multi: true,
                            dataSource: $.const.default.TrueFalse,
                            itemTemplate: function (e) {
                                return "<li class='k-item'><label class='k-label'><input type='checkbox' name='" + e.field + "' value='#= data.Value #'/> #= data.Name || data.all #</label></li>";
                            }
                        }
                    },
                    {
                        field: "Remark",
                        title: "备注",
                        width: 150
                    }
                ]
            })).data("kendoGrid");

            //自定义按钮组
            var buttonDown = $("#buttondown").kendoButtonDown({
                dataSource: [
                    { title: "全部", code: "b_all" },
                    { title: "本年", code: "b_year", sub: true },
                    { title: "本季", code: "b_quarter", sub: true },
                    { title: "本月", code: "b_month", sub: true },
                    { title: "本周", code: "b_week", sub: true },
                    { title: "本日", code: "b_day", sub: true }
                ],
                callback: function (data) {
                    //setDate(data.startDate, data.endDate);
                    queryList();
                }
            }).data("kendoButtonDown");

            //关键字组件
            var keySearch = $("#keysearch").kendoKeySearch({
                minLength: 1,
                done: function (key) {
                    //setDate("", "");
                    //buttonDown.selected("");
                    queryList();
                },
                focus: function (e) {
                    if (!e.key) {
                        var start = $(".buttondowndate input[name=start]").data("kendoDatePicker");
                        var end = $(".buttondowndate input[name=end]").data("kendoDatePicker");
                        e.data = { "startDate": start.value(), "endDate": end.value(), "buttonDown": buttonDown.value() };
                    }
                },
                empty: function (data) {
                    //setDate(data.startDate, data.endDate);
                    //buttonDown.selected(data.buttonDown);
                    queryList();
                }
            }).data("kendoKeySearch");

            //更改日期事件
            function changeDate() {
                buttonDown.selected("");
                queryList();
            }

            //设置日期值
            function setDate(startDate, endDate) {
                start.value(startDate);
                end.value(endDate);
            }

            //列表查询
            function queryList() {
                dataSource.page(1);
                dataSource.skip(0);
            }

            //取查询条件
            function getQuery() {
                var start = $(".buttondowndate input[name=start]").data("kendoDatePicker");
                var end = $(".buttondowndate input[name=end]").data("kendoDatePicker");
                return {
                    startDate: kendo.toString(start.value(), "yyyy/MM/dd 00:00:00"),
                    endDate: kendo.toString(end.value(), "yyyy/MM/dd 23:59:59"),
                    keyWords: keySearch ? keySearch.value() : ""
                }
            }

        });

        function k_func_add() {
            var grid = $("#grid").data("kendoGrid");
            grid.addRow();
        }

        function k_func_edit() {
            var grid = $("#grid").data("kendoGrid");
            var selectedItem = grid.dataItem(grid.select());
            grid.editRow(selectedItem);
        }

        function k_func_delete() {
            alert(3);
        }

    </script>
}